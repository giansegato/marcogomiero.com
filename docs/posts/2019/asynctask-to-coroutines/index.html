<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="A journey from Async Task to Kotlin Coroutines">
<meta itemprop="description" content="Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.
 RSS Parser 2.0: bye bye Async Task, welcome Coroutines This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version.">


<meta itemprop="datePublished" content="2019-01-14T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-01-14T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="953">

  <meta itemprop="image" content="https://miro.medium.com/max/1400/0*BnjRJYi8CNeaKOq1">



<meta itemprop="keywords" content="" />
<meta property="og:title" content="A journey from Async Task to Kotlin Coroutines" />
<meta property="og:description" content="Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.
 RSS Parser 2.0: bye bye Async Task, welcome Coroutines This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.marcogomiero.com/posts/2019/asynctask-to-coroutines/" />

<meta property="og:image" content="https://miro.medium.com/max/1400/0*BnjRJYi8CNeaKOq1" />
<meta property="article:published_time" content="2019-01-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-01-14T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://miro.medium.com/max/1400/0*BnjRJYi8CNeaKOq1"/>

<meta name="twitter:title" content="A journey from Async Task to Kotlin Coroutines"/>
<meta name="twitter:description" content="Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.
 RSS Parser 2.0: bye bye Async Task, welcome Coroutines This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>A journey from Async Task to Kotlin Coroutines</title>
	<link rel="stylesheet" href="https://www.marcogomiero.com/css/style.min.2228be6b0c0388454036050b3f2743e5fd95a0dc0c3564e5623e94748b585ef1.css" integrity="sha256-Iii+awwDiEVANgULPydD5f2VoNwMNWTlYj6UdItYXvE=">
	<style>.bg-img {background-image: url('https://miro.medium.com/max/1400/0*BnjRJYi8CNeaKOq1');}</style>
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://www.marcogomiero.com">Marco Gomiero</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://www.marcogomiero.com/posts/">Blog</a>
				<a href="https://www.marcogomiero.com/talks/">Talks</a>
				<a href="https://www.marcogomiero.com/projects/">Projects</a>
				<a href="https://www.marcogomiero.com/about-me/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="img-btn" class="hdr-btn" title="Featured Image"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-image"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg></button><span class="hdr-social hide-in-mobile"><a href="https://twitter.com/marcoGomier" target="_blank" rel="noopener me" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a><a href="https://www.linkedin.com/in/marco-gomiero-a80857ab/" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="https://github.com/prof18" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
		<script async defer src="https://buttons.github.io/buttons.js"></script>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://www.marcogomiero.com/posts/">Blog</a></li>
			<li><a href="https://www.marcogomiero.com/talks/">Talks</a></li>
			<li><a href="https://www.marcogomiero.com/projects/">Projects</a></li>
			<li><a href="https://www.marcogomiero.com/about-me/">About</a></li>
		</ul>
	</div>


	<div class="bg-img"></div>
	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Jan 14, 2019</span></div>
				<h1>A journey from Async Task to Kotlin Coroutines</h1>
			</header>
			<div class="content">
				

<p>Some weeks ago I released a new version of the RSS Parser Library and I talked about the update in a blog post.</p>

<blockquote>
<p><a href="https://marco.gomiero.com/posts/bye-async-task">RSS Parser 2.0: bye bye Async Task, welcome Coroutines</a>
This update brought a huge change in the infrastructure of the library. SPOILER: Kotlin and coroutines. Today, in this post I want to talk about the transition process and all the decisions that I have made to develop this new version. In this way, I hope to inspire you to leave the Async Task and get into the coroutines world.</p>
</blockquote>

<p>But, before starting with the technical details, I want to share you some resources to get into the coroutine world. If you already know the coroutines you can skip to the second part of the article.</p>

<h2 id="get-into-the-coroutine-world-it-s-funny-i-promise">Get into the coroutine world, it’s funny. I promise:<a href="#get-into-the-coroutine-world-it-s-funny-i-promise" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>The first thing that you can do to get into the coroutine world is doing the codelab provided by Google.</p>

<blockquote>
<p><a href="https://codelabs.developers.google.com/codelabs/kotlin-coroutines/">Using Kotlin Coroutines in your Android App</a></p>
</blockquote>

<p>Don’t worry if you don’t understand all the concepts, the codelab is useful to make the first exploration and to receive the inputs and the tools to study a particular argument.</p>

<p>After the codelab, I suggest you give a look to the official documentation that is well written and full of examples.</p>

<blockquote>
<p><a href="https://github.com/Kotlin/kotlinx.coroutines">Kotlin/kotlinx.coroutines</a></p>
</blockquote>

<p>Then you could read some articles Android specific and not. Here are some articles that I’ve read:</p>

<blockquote>
<p><a href="https://antonis.me/2018/12/12/an-introduction-to-kotlin-coroutines/">An introduction to Kotlin Coroutines*</a></p>

<p><a href="https://proandroiddev.com/how-to-make-sense-of-kotlin-coroutines-b666c7151b93">How to make sense of Kotlin coroutines</a></p>

<p><a href="https://proandroiddev.com/kotlin-coroutines-patterns-anti-patterns-f9d12984c68e">Kotlin Coroutines patterns &amp; anti-patterns</a></p>

<p><a href="https://medium.com/@andrea.bresolin/playing-with-kotlin-in-android-coroutines-and-how-to-get-rid-of-the-callback-hell-a96e817c108b">Playing with Kotlin in Android: coroutines and how to get rid of the callback hell</a></p>

<p><a href="https://medium.com/exploring-android/android-networking-with-coroutines-and-retrofit-a2f20dd40a83">Android Networking with Coroutines and Retrofit</a></p>

<p><a href="https://blog.oozou.com/handle-complex-network-call-with-kotlin-coroutine-retrofit-2-30a6cd1e0189">Handle Complex Network Call with Kotlin Coroutine + Retrofit 2</a></p>

<p><a href="https://proandroiddev.com/async-code-using-kotlin-coroutines-233d201099ff">Async code using Kotlin Coroutines</a></p>
</blockquote>

<p>I suggest also the talks of Chris Banes and Christina Lee:</p>

<blockquote>
<p><a href="https://chris.banes.me/talks/2018/android-suspenders/">So you’ve read the Coroutines guide and you’re ready to start using them in your Android app to coroutines? Great!</a></p>

<p><a href="https://skillsmatter.com/skillscasts/12727-coroutines-by-example">Coroutines By Example</a></p>
</blockquote>

<p>Of course, there are lots of resources available and lots of ways to learn the coroutines. These are some advice based on my experience and learning path.</p>

<h2 id="the-path-from-async-task-to-coroutines">The Path From Async Task to Coroutines<a href="#the-path-from-async-task-to-coroutines" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>

<p>The first release of the library is dated 18 June 2016, a period when there wasn’t all the beautiful stuff that there is today (for instance, Kotlin) and moreover I did not know all the stuff that I know today. The code was so simple (and now I can also say that was ugly) but it was working.</p>

<h3 id="old-school-java-code">Old School Java Code<a href="#old-school-java-code" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>I used an Async Task to handle the network request; the result of the request is sent to an XML Parser that notifies its result when the parsing was done. Here’s the code of the Parser:</p>

<script type="application/javascript" src="//gist.github.com/prof18/58fe7e2afb9a5f070413d570bff9af8c.js"></script>

<p>Then, the result of the parsing (or an error of parsing) is notified to the “main executor” (the application that uses the library) with two simple callbacks.</p>

<script type="application/javascript" src="//gist.github.com/prof18/ac5463e4293c09bfb9f62aebb0064791.js"></script>

<h3 id="kotlin-and-coroutines-a-love-story">Kotlin and Coroutines, a love story<a href="#kotlin-and-coroutines-a-love-story" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>

<p>After 2 years, I wanted to get rid of Async Task, Java and all the ugly stuff. The perfect candidates for taking the place are Kotlin and the coroutines. However, my biggest concern was maintaining the compatibility with all the devs that still use Java (seriously guys? Love yourself, move to Kotlin). In fact, the Kotlin coroutines cannot be invoked from Java code.</p>

<p>At first, I tried to figure out if there was a method to call the coroutines from Java but finally I came up with a brilliant idea: provide the support for both the ways.</p>

<p>For the Java support, I decided to use <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Future.html">Future</a> and <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Callable.html">Callable</a> to handle the asynchronous operations. In particular, I implemented two classes that perform respectively the fetching and the parsing task.</p>

<script type="application/javascript" src="//gist.github.com/prof18/2ab1b2dfbc6e612d37a68813643a566a.js"></script>

<p>The result of the parsing is then notified to the “main executor” using the same callbacks reported above.</p>

<script type="application/javascript" src="//gist.github.com/prof18/483b80ae8001598495b7dc5b7975b95d.js"></script>

<p>In this way, the old users of the library can still call the same code without noticing any kind of difference but the new ones (and of course also the old) can learn and use the new way.</p>

<p>As you can image, the new part is written using the Kotlin coroutines. As above, I separated the fetching and the parsing task. The fetching task is performed by the <em>fetchXML</em> suspending function, that takes the URL of the RSS feed as input and returns a <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-deferred/">Deferred</a> object that will be the input of the <em>parseXML</em> suspend function. This function will then parse the RSS Feed and returns a list of parsed data.</p>

<script type="application/javascript" src="//gist.github.com/prof18/744a179e37b9f29467086a783a742ad6.js"></script>

<p>These functions are exposed to the “main executor” by using another suspend function, that it will get and parse asynchronously the RSS feed.</p>

<script type="application/javascript" src="//gist.github.com/prof18/7fa549bda752f37e054d13660e74fe79.js"></script>

<p>All the suspend functions reported above are called with the IO Dispatcher that uses a shared pool of on-demand created threads. There are also other dispatchers, give a look to the <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-dispatcher/">documentation</a> to find the one that better suits your needs.</p>

<p>And finally, from the ViewModel (or in whatever place depending on the architecture of your app) you can launch the coroutine with a <a href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-coroutine-scope/">Scope</a>, so, for example, you can stop it if the activity is destroyed, and then “transform” an URL to a List of Articles.</p>

<script type="application/javascript" src="//gist.github.com/prof18/d9fc7813e9058a7e00f28c11f13c9284.js"></script>

<p>And finally, we have reached the end of my journey from Async Task to Coroutines. If you have some advice, doubt or any kind of feedback, please leave a comment! Of course, you can use this example as an idea to leave forever the (ugly) Async Tasks.</p>

<p>If you want to contribute to the development of the library or simply report a bug, visit the repo on Github: <a href="https://github.com/prof18/RSS-Parser">https://github.com/prof18/RSS-Parser</a></p>

<p>A special thanks to the (awesome) devs of the Android Developers Italia Community that gave to me some advice. If you are Italian, join us on <a href="https://androiddevs.it/">Slack</a>!</p>

<hr />

<p><em>Published also on <a href="https://medium.com/@marcogomiero/a-journey-from-async-task-to-kotlin-coroutines-735c273d76cb">Medium</a></em></p>

			</div>

			<hr class="post-end">
			<footer class="post-info">
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>953 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-01-14 01:00 &#43;0100</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://www.marcogomiero.com/posts/2019/bottom-bar-swipe-flutter/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;Newer</span><br><span>Bottom App Bar with Menu and Swipeable Tabs in Flutter</span>
			</a>
			<a class="prev-post" href="https://www.marcogomiero.com/posts/2018/bye-async-task/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>RSS Parser 2.0: bye bye Async Task, welcome Coroutines</span>
			</a>
		</div>
		<div id="comments" class="thin">
<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "marcogomiero" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2020 <a href="https://www.marcogomiero.com">Marco Gomiero</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://www.marcogomiero.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>


	<script src="https://www.marcogomiero.com/js/main.min.35ccbf1cdceb91e4c64c06b5d009d6e2977fafe56beda7762febd4e67528d2ac.js" integrity="sha256-Ncy/HNzrkeTGTAa10AnW4pd/r+Vr7ad2L+vU5nUo0qw="></script>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-90975904-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
